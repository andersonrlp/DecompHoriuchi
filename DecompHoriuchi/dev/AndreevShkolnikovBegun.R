
# Author: tim
###############################################################################
Mxc1 <- structure(c(3.488769218541e-05, 3.089922318263e-05, 3.131279890782e-05, 
				3.048578626033e-05, 4.240313987854e-05, 6.000043622918e-05, 7.375567047343e-05, 
				0.00011749200131586, 0.00020477819686457, 0.00043889291284967, 
				0.00091377669521392, 0.00173870069391953, 0.00313165553223672, 
				0.0052605029094402, 0.0080904194584411, 0.01177821890384, 0.0159138593490072, 
				0.0201058340646797, 0.0259221542713819, 0.00017348089043235, 
				1.545063866574e-05, 5.59544887584e-06, 1.265706172918e-05, 3.218650476185e-05, 
				5.111488055298e-05, 9.139671646671e-05, 0.00016626081384758, 
				0.00033498936782353, 0.00068708087596571, 0.0012520345053433, 
				0.00207723703375474, 0.00329054371478053, 0.00515204360496294, 
				0.0080564903097637, 0.0129177440780988, 0.0214796192199823, 0.0364709957047803, 
				0.0765994237854344, 0.00018801448800098, 2.19821591664e-05, 6.87146108359e-06, 
				8.96138302285e-06, 1.413502585215e-05, 1.584624991799e-05, 1.939935392372e-05, 
				2.830919719484e-05, 4.555906808205e-05, 8.333125040534e-05, 0.00014240583778009, 
				0.00025522579144374, 0.00050206298262886, 0.00102886654804988, 
				0.00197494009885781, 0.00379685058382944, 0.00661791787110881, 
				0.0109431614390073, 0.0215015624111759, 0.00015119484239566, 
				9.29580085108e-06, 3.23957309106e-06, 2.86409745593e-06, 4.01150163886e-06, 
				9.27634042142e-06, 1.473183330718e-05, 4.137715193736e-05, 9.084900159458e-05, 
				0.00020698080264094, 0.00037023648038176, 0.00048717581848391, 
				0.00054176058749146, 0.00065269374679357, 0.00083872337960728, 
				0.00111805908158916, 0.00155614707702732, 0.00227733218756484, 
				0.00404421279587638, 0.00037692008797637, 0.00016309511367126, 
				7.920539556412e-05, 0.00012670464815122, 0.00076545409670505, 
				0.0011415815405149, 0.00095699501090145, 0.00084886597164232, 
				0.0009044876621818, 0.00096280902876118, 0.00094677131771524, 
				0.00083234149428451, 0.00076845490396117, 0.00073401525928892, 
				0.00082492657869434, 0.0010502455027005, 0.00150461467508431, 
				0.00226372972592444, 0.00415281780047963, 0.00669285669954965, 
				0.00011180610671303, 4.087882077415e-05, 4.89607528395e-05, 8.21421990179e-05, 
				0.00013042079424681, 0.00018779946128393, 0.00029218598546631, 
				0.00048546366054585, 0.00068541264027541, 0.00092234748220177, 
				0.00114581688285846, 0.00138557929742784, 0.00193539220997854, 
				0.00287829679590917, 0.00467736551131298, 0.00816808916074605, 
				0.0144834812424242, 0.0303637496325015), .Dim = c(19L, 6L), .Dimnames = list(
				c("0", "1-4", "5-9", "10-14", "15-19", "20-24", "25-29", 
						"30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", 
						"65-69", "70-74", "75-79", "80-84", "85+"), c("Neoplasms", 
						"Diseases.of.the.circulatory.system", "Diseases.of.the.respiratory.system", 
						"Diseases.of.the.digestive.system", "Accidents.and.violence", 
						"All.other")))



Mxc2 <- structure(c(2.32403718459e-05, 3.92565294023e-05, 3.53526274792e-05, 
				4.0684861841e-05, 5.36904832143e-05, 6.35539894286e-05, 7.62994754411e-05, 
				0.0001143856143856, 0.0001932249586294, 0.0003863140531049, 0.0008069077561827, 
				0.0015710059171598, 0.0029336813972279, 0.0051976994967649, 0.008142140168489, 
				0.0125554971067859, 0.0186070060207991, 0.0238540114918068, 0.0342090494563311, 
				8.63213811421e-05, 1.36196122416e-05, 5.3927736833e-06, 9.0410804091e-06, 
				2.30102070919e-05, 4.09010823056e-05, 6.37815927515e-05, 0.0001113886113886, 
				0.0002219410104157, 0.0004911403182036, 0.0009663638004693, 0.0016165680473373, 
				0.0026185592640935, 0.0046784886971803, 0.0080381788851049, 0.0144134665965281, 
				0.0254337712096333, 0.0415237284528623, 0.0797930550683971, 0.0001361221779548, 
				1.52219195642e-05, 7.190364911e-06, 1.07362829858e-05, 1.2390111511e-05, 
				2.2023659703e-05, 1.96709585122e-05, 2.84715284715e-05, 4.72111359875e-05, 
				6.49177885383e-05, 0.0001311751609603, 0.0002414201183432, 0.0004642923736715, 
				0.0009513539420081, 0.0018022943179781, 0.0038421883219358, 0.00814039408867, 
				0.0146414130666099, 0.0360890915468257, 6.30810092961e-05, 7.2103829515e-06, 
				2.9959853796e-06, 2.2602701023e-06, 4.7200424804e-06, 1.25849484017e-05, 
				2.68240343348e-05, 5.99400599401e-05, 0.0001343327168305, 0.0002405150854041, 
				0.0003784824598351, 0.0004520710059172, 0.0005196096712039, 0.0006605958942408, 
				0.0008845671267252, 0.0012772225144661, 0.0021455938697318, 0.0032326026814216, 
				0.005987372851631, 9.62815405046e-05, 4.16599903862e-05, 2.57654742645e-05, 
				4.57704695711e-05, 0.0002891026019234, 0.0004656430908633, 0.000466142107773, 
				0.0004525474525475, 0.0004526428501898, 0.0004405895812271, 0.000408568505927, 
				0.0003591715976331, 0.0003412269252284, 0.0003330936975797, 0.000314572504033, 
				0.0004944765912678, 0.000727969348659, 0.0012130240476697, 0.0029849175727815, 
				0.0056142098273572, 0.000135394968755, 4.13445982384e-05, 4.97259422501e-05, 
				0.0001085609770488, 0.0001774477724641, 0.0002068431092036, 0.0002462537462537, 
				0.0002399493818748, 0.0002649922843612, 0.000356820506649, 0.0004041420118343, 
				0.000532040524582, 0.0007995846313603, 0.0013272987990679, 0.0025291951604419, 
				0.005099890530925, 0.0099021068312407, 0.0289301999298492), .Dim = c(19L, 
				6L), .Dimnames = list(c("0", "1-4", "5-9", "10-14", "15-19", 
						"20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", 
						"55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+"), 
				c("Neoplasms", "Diseases.of.the.circulatory.system", "Diseases.of.the.respiratory.system", 
						"Diseases.of.the.digestive.system", "Accidents.and.violence", 
						"All.other")))

Compare <- structure(c(0.00087255358977565, -0.00243456704991705, -0.00137321815572911, 
				-0.00321409653160529, -0.00327755728502529, -0.00094417553774579, 
				-0.00061345873374599, 0.00067332187423214, 0.00222404597370212, 
				0.00885742411442626, 0.0154659292914988, 0.02036396945502, 0.0195621138295644, 
				0.00484604226122052, -0.00294704351753303, -0.0302514453848436, 
				-0.0641710941297375, -0.0469258339373584, -0.0782013703184325, 
				0.00652951313893695, 0.0005333963443911, 6.88933327434e-05, 0.00113952611596524, 
				0.00266456326549059, 0.00271379592567899, 0.00665960569792515, 
				0.0118937698916985, 0.0217622693809256, 0.033008089687693, 0.0413418466618998, 
				0.0559411184022004, 0.0663995579274147, 0.036540390044192, 0.00104338363450758, 
				-0.058213117683006, -0.0942163710148616, -0.0632570555031898, 
				-0.0302013460846362, 0.00388748797456972, 0.00196932553154892, 
				-0.00010840175956967, -0.00055933498667713, 0.0005066787140444, 
				-0.00164133162163083, -6.549959939595e-05, -3.518595798179e-05, 
				-0.00031802989045436, 0.00310192845927718, 0.00162528917696842, 
				0.00167648962937719, 0.00373217307306923, 0.00598103373792043, 
				0.00983733473335585, -0.00176453103030193, -0.0362773804330255, 
				-0.0463008184691077, -0.137300526117696, 0.0066010058400772, 
				0.0006075031301967, 8.280031238558e-05, 0.00019028777490059, 
				-0.00020574222768488, -0.00087909383711976, -0.00291613017958809, 
				-0.00402358517891971, -0.00837079549795625, -0.00564918028077462, 
				-0.00119334770061078, 0.00426294658521253, 0.00218876698435094, 
				-0.0006097464421444, -0.00261217436545991, -0.00619459300433789, 
				-0.0140454211004447, -0.0119601863989885, -0.0183855264399516, 
				0.021023894999678, 0.0353752669851464, 0.0181652929640237, 0.0255052779289456, 
				0.138320258488215, 0.179595933854453, 0.11837298083589, 0.0859035841832445, 
				0.0869818962653831, 0.0879728328918779, 0.0778878334586478, 0.0574591563365254, 
				0.042214957325422, 0.030935878104826, 0.0290798510217588, 0.0216303498701799, 
				0.0185063106555968, 0.0131554840186428, 0.011064600937998, 0.0808061560735768, 
				-0.00687167192568208, -0.00015832703262883, -0.00024113877830677, 
				-0.0076713410456031, -0.0124950222244651, -0.00459252677677367, 
				0.0099559971465716, 0.0472624838431562, 0.0708238338446749, 0.0818421316093367, 
				0.09006478827197, 0.0843390482954875, 0.087640692128163, 0.088374931078073, 
				0.0836060295529413, 0.073112605339326, 0.0573649303865729, 0.0135828471251698
		), .Dim = c(19L, 6L), .Dimnames = list(c("0", "1-4", "5-9", "10-14", 
						"15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", 
						"50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", 
						"85+"), c("Neoplasms", "Diseases.of.the.circulatory.system", 
						"Diseases.of.the.respiratory.system", "Diseases.of.the.digestive.system", 
						"Accidents.and.violence", "All.other")))

LTabr <- function(Mx, Age = c(0,1,cumsum(rep(5,length(Mx)-2))),radix = 1e5){
	# based on lifetable formulas in Spreadsheet:
	# Andreev & Shkolnikov (2012) An Excel spreadsheet for the 
	# decomposition of a difference between two values of an 
	# aggregate demographic measure by stepwise replacement 
	# running from young to old ages 
	# MPIDR technical report 2012-002
	# attached file tr-2012-002-files.zip
	# containing spreadsheet
	# "Decomposition_replacement_from_young_to_old_ages(1).xls
	
	# TR: this is not HMD exactly, since it's an abridged lifetable. a(x) values
	# will all be different from HMD. Other potential differences are of lesser consequence
	# i.e. closeout at age 85, etc.
	N     <- length(Mx)
	w     <- c(diff(Age),5)
	
	ax    <- c(0.07 + 1.7 * Mx[1],.4,rep(.5,N - 3), 1/Mx[N])
	Nax   <- w * ax
	qx    <- (w * Mx) / (1 + w * (1 - ax) * Mx)
	qx[N] <- 1
	px    <- 1 - qx
	lx    <- c(radix, radix * (cumprod(px[-N])))
	dx    <- -diff(c(lx, 0))
	Lx    <- lx[-1] * w[-N] + dx[-N] * Nax[-N]
	Lx[N] <- ax[N] * lx[N]
	Tx    <- rev(cumsum(rev(Lx)))
	ex <- Tx / lx
	ex[1]
}

Mxc2e0abr <- function(Mxc){
	Mx <- rowSums(Mxc)
	LTabr(Mx)
}
Mxc2e0abrvec <- function(Mxcvec, dims, trans = FALSE){
	dim(Mxcvec) <- dims
	if (trans){
		Mxcvec <- t(Mxcvec)
	}
	Mxc2e0abr(Mxcvec)
}


stepwise_replacement <- function(func, rates1, rates2, symmetrical = TRUE, direction = "up",...){
	direction <- tolower(direction)
	stopifnot(direction %in% c("up","down","both"))
	
	up                   <- direction %in% c("up","both")
	down                 <- direction %in% c("down","both")
	N                    <- length(rates1)
	
	Rates1Mat            <- matrix(rates1, ncol = N + 1, nrow = N)
	Rates2Mat            <- matrix(rates2, ncol = N + 1, nrow = N)
	
	RM_1_2_up            <- matrix(ncol = N + 1, nrow = N)
	RM_1_2_down          <- RM_1_2_up
	RM_2_1_up            <- RM_1_2_up
	RM_2_1_down          <- RM_1_2_up
	
	RatesMat_down        <- RatesMatascend
	
	# based on 1-> 2 upward
	r1ind                     <- lower.tri(Rates1Mat, TRUE)
	r2ind                     <- upper.tri(Rates1Mat)
	
	RM_1_2_up[r1ind]          <- Rates1Mat[r1ind]
	RM_1_2_up[r2ind]          <- Rates2Mat[r2ind]
	
	RM_1_2_down[r1ind[N:1, ]] <- Rates1Mat[r1ind[N:1, ]]
	RM_1_2_down[r2ind[N:1, ]] <- Rates2Mat[r2ind[N:1, ]]
	
	RM_2_1_up[r1ind]          <- Rates2Mat[r1ind]
	RM_2_1_up[r2ind]          <- Rates1Mat[r2ind]
	
	RM_2_1_down[r1ind[N:1, ]] <- Rates2Mat[r1ind[N:1, ]]
	RM_2_1_down[r2ind[N:1, ]] <- Rates1Mat[r2ind[N:1, ]]
	
	dec                       <- matrix(NA, nrow = N, ncol = 4)
	colnames(dec)             <- c("12up","12down","21up","21down")
	if (up){
		dec[, 1]              <- diff(apply(RM_1_2_up, 2, func, ...))
	}
	if (down){
		dec[, 2]              <- diff(apply(RM_1_2_down, 2, func, ...))
	}
	
	if (symmetrical){
		if (up){
			dec[, 3]          <- -diff(apply(RM_2_1_up, 2, func, ...))
		}
		if (down){
			dec[, 4]          <- -diff(apply(RM_2_1_down, 2, func, ...))
		}
    }

	
	dec_avg                   <- rowMeans(dec, na.rm=TRUE)
	dec_avg
}

# results vary somewhat, order dependent as they say in the paper.
dec1 <- stepwise_replacement(Mxc2e0abrvec, c(Mxc1),c(Mxc2), 
		symmetrical = TRUE, direction = "both", dims = dim(Mxc1))
dec2 <- stepwise_replacement(Mxc2e0abrvec, c(Mxc1),c(Mxc2), 
		symmetrical = TRUE, direction = "up", dims = dim(Mxc1))
dec3 <- stepwise_replacement(Mxc2e0abrvec, c(Mxc1),c(Mxc2), 
		symmetrical = TRUE, direction = "down", dims = dim(Mxc1))

dec4 <- stepwise_replacement(Mxc2e0abrvec, c(Mxc1),c(Mxc2), 
		symmetrical = FALSE, direction = "both", dims = dim(Mxc1))
dec5 <- stepwise_replacement(Mxc2e0abrvec, c(Mxc1),c(Mxc2), 
		symmetrical = FALSE, direction = "up", dims = dim(Mxc1))
dec6 <- stepwise_replacement(Mxc2e0abrvec, c(Mxc1),c(Mxc2), 
		symmetrical = FALSE, direction = "down", dims = dim(Mxc1))

dim(dec1) <- dim(dec2) <- dim(dec3) <- 
		dim(dec4) <- dim(dec5) <- dim(dec6) <- dim(Mxc1)
# what about with transpose?
dec1.1 <- stepwise_replacement(Mxc2e0abrvec, c(t(Mxc1)), c(t(Mxc2)), 
		symmetrical = TRUE, direction = "both",
		trans = TRUE, dims = dim(t(Mxc1)))
dim(dec1.1)  <- dim(t(Mxc1))
dec1.1       <- t(dec1.1)

dec2.1 <- stepwise_replacement(Mxc2e0abrvec, c(t(Mxc1)), c(t(Mxc2)), 
		symmetrical = TRUE, direction = "up",
		trans = TRUE, dims = dim(t(Mxc1)))
dim(dec2.1)  <- dim(t(Mxc1))
dec2.1       <- t(dec2.1)

dec3.1 <- stepwise_replacement(Mxc2e0abrvec, c(t(Mxc1)), c(t(Mxc2)), 
		symmetrical = TRUE, direction = "down",
		trans = TRUE, dims = dim(t(Mxc1)))
dim(dec3.1)  <- dim(t(Mxc1))
dec3.1       <- t(dec3.1)

dec4.1 <- stepwise_replacement(Mxc2e0abrvec, c(t(Mxc1)), c(t(Mxc2)), 
		symmetrical = FALSE, direction = "both",
		trans = TRUE, dims = dim(t(Mxc1)))
dim(dec4.1)  <- dim(t(Mxc1))
dec4.1       <- t(dec4.1)

dec5.1 <- stepwise_replacement(Mxc2e0abrvec, c(t(Mxc1)), c(t(Mxc2)), 
		symmetrical = FALSE, direction = "up",
		trans = TRUE, dims = dim(t(Mxc1)))
dim(dec5.1)  <- dim(t(Mxc1))
dec5.1       <- t(dec5.1)

dec6.1 <- stepwise_replacement(Mxc2e0abrvec, c(t(Mxc1)), c(t(Mxc2)), 
		symmetrical = FALSE, direction = "down",
		trans = TRUE, dims = dim(t(Mxc1)))
dim(dec6.1)  <- dim(t(Mxc1))
dec6.1       <- t(dec6.1)

# sums
sum(dec1); sum(dec2); sum(dec3); sum(dec4); sum(dec5); sum(dec6)
sum(dec1.1); sum(dec2.1); sum(dec3.1); sum(dec4.1); sum(dec5.1); sum(dec6.1)

# Compare with spreadsheet results.
sum(abs(dec1-Compare))   # 2.512767
sum(abs(dec2-Compare))   # 0.006418541 # up ages, symmetrical is closest to prescribed I guess
sum(abs(dec3-Compare))   # 5.028025
sum(abs(dec4-Compare))   # 2.587519
sum(abs(dec5-Compare))   # 0.09675932
sum(abs(dec6-Compare))   # 5.102777

sum(abs(dec1.1-Compare)) # 2.512767
sum(abs(dec2.1-Compare)) # 0.001559639
sum(abs(dec3.1-Compare)) # 5.025405
sum(abs(dec4.1-Compare)) # 2.465763
sum(abs(dec5.1-Compare)) # 0.09731817
sum(abs(dec6.1-Compare)) # 4.9784

# not an exact replication. My guess is that
# difference is due to ordering

decH <- DecompContinuousOrig(Mxc2e0abrvec,c(Mxc1),c(Mxc2),N = 20, dims = dim(Mxc1))
dim(decH) <- dim(Mxc1)

sum(abs(dec1-decH))   # 2.509027
sum(abs(dec2-decH))   # 0.006593741 # up ages, symmetrical is closest to prescribed I guess
sum(abs(dec3-decH))   # 5.024286
sum(abs(dec4-decH))   # 2.583779
sum(abs(dec5-decH))   # 0.09390728
sum(abs(dec6-decH))   # 5.099037

sum(abs(dec1.1-decH)) # 2.509027
sum(abs(dec2.1-decH)) # 0.004125542
sum(abs(dec3.1-decH)) # 5.021665
sum(abs(dec4.1-decH)) # 2.462023
sum(abs(dec5.1-decH)) # 0.1008572
sum(abs(dec6.1-decH)) # 4.974661


# in case you were curious:
sum(abs(Compare-decH)) # 0.004308457


# these are all reasonably close
matplot(Compare, type = 'l')
matplot(decH, type = 'l',add=TRUE)
matplot(dec2, type = 'l',add=TRUE)

# -----------------
#matplot(dec1, type = 'l')
#matplot(dec2, type = 'l')
#matplot(dec3, type = 'l')
#matplot(dec4, type = 'l')
#matplot(dec5, type = 'l')
#matplot(dec6, type = 'l')
#matplot(dec1.1, type = 'l')
#matplot(dec2.1, type = 'l')
#matplot(dec3.1, type = 'l')
#matplot(dec4.1, type = 'l')
#matplot(dec5.1, type = 'l')
#matplot(dec6.1, type = 'l')

library(devtools)
setwd("/home/tim/git/DecompHoriuchi")
document("DecompHoriuchi")

